# üîí ClickWars: Territory - Pipeline CI S√©curis√©
# ‚ö° Adapt√© au projet : Frontend Qt6/QML + Backend Node.js WebSocket
# üìñ Ce workflow est 100% LECTURE SEULE - il ne modifie JAMAIS ton code

name: ClickWars CI

# üîí Permissions minimales - lecture seule uniquement
permissions:
  contents: read

# üìÖ D√©clenchement
on:
  push:
    branches: [main, mike]
  pull_request:
    branches: [main]

# üîí Annule les anciens runs si un nouveau push arrive
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===================================
  # 1. SERVEUR NODE.JS (Backend)
  # V√©rifie que le serveur WebSocket fonctionne
  # ===================================
  backend:
    name: üñ•Ô∏è Backend Node.js
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: üì• R√©cup√©ration du code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: üì¶ Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: üì¶ Installation d√©pendances (s√©curis√©e)
        working-directory: ./server
        run: npm install --ignore-scripts

      # V√©rifie que le package ws n'a pas de failles connues
      - name: üîí Audit s√©curit√© npm
        working-directory: ./server
        run: npm audit --audit-level=high || echo "‚ö†Ô∏è Vuln√©rabilit√©s d√©tect√©es"

      # V√©rifie la syntaxe de TOUS les fichiers JS du serveur
      - name: ‚úÖ Syntaxe websocket-server.js
        working-directory: ./server
        run: node --check websocket-server.js

      - name: ‚úÖ Syntaxe GameServer.js
        working-directory: ./server
        run: node --check GameServer.js

      - name: ‚úÖ Syntaxe add-lobby-bots.js
        working-directory: ./server
        run: node --check add-lobby-bots.js

      - name: ‚úÖ Syntaxe simulate-clicks.js
        working-directory: ./server
        run: node --check simulate-clicks.js

      - name: ‚úÖ Syntaxe simulate-team-clicks.js
        working-directory: ./server
        run: node --check simulate-team-clicks.js

      # D√©marre le serveur et v√©rifie qu'il ne crash pas
      - name: üöÄ Test d√©marrage serveur WebSocket (port 7777)
        working-directory: ./server
        run: |
          node websocket-server.js &
          SERVER_PID=$!
          sleep 3

          if kill -0 $SERVER_PID 2>/dev/null; then
            echo "‚úÖ websocket-server.js d√©marre correctement (PID: $SERVER_PID)"
            kill $SERVER_PID
          else
            echo "‚ùå Le serveur a crash√© au d√©marrage!"
            exit 1
          fi

      # V√©rifie que le dashboard HTML est valide
      - name: üìä V√©rification dashboard.html
        working-directory: ./server
        run: |
          if [ -f "dashboard.html" ]; then
            echo "‚úÖ dashboard.html pr√©sent ($(wc -c < dashboard.html) bytes)"
          else
            echo "‚ùå dashboard.html manquant!"
            exit 1
          fi

  # ===================================
  # 2. FRONTEND QT/QML
  # V√©rifie que tous les fichiers QML et C++ sont pr√©sents
  # ===================================
  frontend:
    name: üì± Frontend Qt/QML
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: üì• R√©cup√©ration du code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # V√©rifie CHAQUE fichier list√© dans CMakeLists.txt
      - name: ‚úÖ Fichiers C++ (sources)
        run: |
          echo "ÔøΩ V√©rification des sources C++..."
          MISSING=0
          for f in src/Main.cpp src/websocketserver.h src/websocketserver.cpp; do
            if [ -f "$f" ]; then
              echo "  ‚úÖ $f"
            else
              echo "  ‚ùå $f MANQUANT!"
              MISSING=$((MISSING+1))
            fi
          done
          [ $MISSING -eq 0 ] || exit 1

      - name: ‚úÖ Fichiers QML (√©crans)
        run: |
          echo "ÔøΩ V√©rification des √©crans QML..."
          MISSING=0
          for f in \
            qml/Main.qml \
            qml/screens/MainMenuScreen.qml \
            qml/screens/GameScreen.qml \
            qml/screens/LobbyScreen.qml \
            qml/screens/ServerBrowserScreen.qml \
            qml/screens/NetworkTest.qml; do
            if [ -f "$f" ]; then
              echo "  ‚úÖ $f"
            else
              echo "  ‚ùå $f MANQUANT!"
              MISSING=$((MISSING+1))
            fi
          done
          [ $MISSING -eq 0 ] || exit 1

      - name: ‚úÖ Fichiers QML (composants)
        run: |
          echo "üîç V√©rification des composants QML..."
          MISSING=0
          for f in \
            qml/components/AnimatedButton.qml \
            qml/components/GameStateManager.qml \
            qml/components/NetworkManager.qml \
            qml/components/ToastNotification.qml \
            qml/components/ClickZone.qml \
            qml/components/BotController.qml \
            qml/components/GaugeBar.qml \
            qml/components/LatencyStatsPanel.qml \
            qml/styles/Theme.qml; do
            if [ -f "$f" ]; then
              echo "  ‚úÖ $f"
            else
              echo "  ‚ùå $f MANQUANT!"
              MISSING=$((MISSING+1))
            fi
          done
          [ $MISSING -eq 0 ] || exit 1

      - name: ‚úÖ Fichiers JS (logique QML)
        run: |
          echo "üîç V√©rification des modules JS..."
          MISSING=0
          for f in qml/js/GameState.js qml/js/BotManager.js; do
            if [ -f "$f" ]; then
              echo "  ‚úÖ $f"
            else
              echo "  ‚ùå $f MANQUANT!"
              MISSING=$((MISSING+1))
            fi
          done
          [ $MISSING -eq 0 ] || exit 1

      # V√©rifie que qmldir d√©clare bien tous les composants
      - name: ‚úÖ Registres qmldir
        run: |
          echo "üîç V√©rification des fichiers qmldir..."
          for dir in qml/components qml/screens qml/styles; do
            if [ -f "$dir/qmldir" ]; then
              echo "  ‚úÖ $dir/qmldir"
            else
              echo "  ‚ùå $dir/qmldir MANQUANT!"
              exit 1
            fi
          done

      # V√©rifie que CMakeLists.txt est coh√©rent
      - name: ‚úÖ CMakeLists.txt
        run: |
          echo "ÔøΩ V√©rification CMakeLists.txt..."
          if [ ! -f "CMakeLists.txt" ]; then
            echo "‚ùå CMakeLists.txt manquant!"
            exit 1
          fi
          echo "  ‚úÖ CMakeLists.txt pr√©sent"

          # V√©rifie que les d√©pendances Qt sont d√©clar√©es
          for dep in Core Quick Qml Network WebSockets; do
            if grep -q "$dep" CMakeLists.txt; then
              echo "  ‚úÖ Qt6::$dep d√©clar√©"
            else
              echo "  ‚ö†Ô∏è Qt6::$dep non trouv√© dans CMakeLists.txt"
            fi
          done

  # ===================================
  # 3. S√âCURIT√â
  # V√©rifie qu'aucun secret n'est expos√© dans le code
  # ===================================
  security:
    name: üîí S√©curit√©
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: üì• R√©cup√©ration du code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # Cherche des mots de passe ou cl√©s API oubli√©s dans le code
      - name: üîë D√©tection de secrets expos√©s
        run: |
          echo "üîç Recherche de secrets dans le code..."
          FOUND=0
          for pattern in "password\s*[:=]" "api_key\s*[:=]" "secret_key" "private_key" "AWS_ACCESS"; do
            RESULTS=$(grep -rnI "$pattern" \
              --include="*.js" --include="*.qml" --include="*.cpp" --include="*.h" --include="*.json" \
              --exclude-dir=node_modules --exclude-dir=.git \
              --exclude="package-lock.json" --exclude="*.yml" . 2>/dev/null || true)
            if [ -n "$RESULTS" ]; then
              echo "  ‚ö†Ô∏è Pattern suspect: $pattern"
              echo "$RESULTS" | head -3
              FOUND=$((FOUND+1))
            fi
          done
          if [ $FOUND -eq 0 ]; then
            echo "  ‚úÖ Aucun secret expos√©!"
          else
            echo "  ‚ö†Ô∏è $FOUND pattern(s) suspect(s) - v√©rifie que ce ne sont pas de vrais secrets!"
          fi

      # V√©rifie qu'aucun fichier √©norme n'a √©t√© push√© par erreur
      - name: üì¶ V√©rification taille des fichiers
        run: |
          echo "üì¶ Recherche de fichiers > 1 Mo..."
          BIG=$(find . -type f -size +1M -not -path './.git/*' -not -path '*/node_modules/*' 2>/dev/null)
          if [ -z "$BIG" ]; then
            echo "  ‚úÖ Aucun fichier volumineux!"
          else
            echo "  ‚ö†Ô∏è Fichiers volumineux:"
            echo "$BIG" | while read f; do echo "    ‚Ä¢ $f ($(du -h "$f" | cut -f1))"; done
          fi

      # V√©rifie que le port WebSocket n'est pas expos√© en dur avec une IP publique
      - name: üåê V√©rification IP/Ports
        run: |
          echo "üîç V√©rification des IP cod√©es en dur..."
          # Cherche des IP publiques (pas localhost/127.0.0.1/0.0.0.0)
          PUBLIC_IPS=$(grep -rnI '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}' \
            --include="*.js" --include="*.qml" --include="*.cpp" \
            --exclude-dir=node_modules --exclude-dir=.git . 2>/dev/null | \
            grep -v "127.0.0.1" | grep -v "0.0.0.0" | grep -v "localhost" || true)
          if [ -z "$PUBLIC_IPS" ]; then
            echo "  ‚úÖ Aucune IP publique cod√©e en dur!"
          else
            echo "  ‚ö†Ô∏è IP potentiellement publiques d√©tect√©es:"
            echo "$PUBLIC_IPS" | head -5
          fi

  # ===================================
  # 4. STATISTIQUES DU PROJET
  # ===================================
  stats:
    name: üìä Stats Projet
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: üì• R√©cup√©ration du code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: üìä R√©sum√© du projet ClickWars
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë    üìä ClickWars: Territory - Stats       ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "üìÅ Structure:"
          echo "  ‚Ä¢ Fichiers QML      : $(find . -name '*.qml' | wc -l)"
          echo "  ‚Ä¢ Fichiers JS (QML) : $(find ./qml -name '*.js' 2>/dev/null | wc -l)"
          echo "  ‚Ä¢ Fichiers JS (srv) : $(find ./server -name '*.js' -not -path '*/node_modules/*' | wc -l)"
          echo "  ‚Ä¢ Fichiers C++      : $(find . -name '*.cpp' -o -name '*.h' | wc -l)"
          echo "  ‚Ä¢ Fichiers HTML     : $(find . -name '*.html' | wc -l)"
          echo ""
          echo "üìè Lignes de code:"
          echo "  ‚Ä¢ QML  : $(find . -name '*.qml' -exec cat {} + 2>/dev/null | wc -l) lignes"
          echo "  ‚Ä¢ JS   : $(find . -name '*.js' -not -path '*/node_modules/*' -exec cat {} + 2>/dev/null | wc -l) lignes"
          echo "  ‚Ä¢ C++  : $(find . \( -name '*.cpp' -o -name '*.h' \) -exec cat {} + 2>/dev/null | wc -l) lignes"
          echo ""
          echo "üéÆ Composants du jeu:"
          echo "  ‚Ä¢ √âcrans   : $(ls qml/screens/*.qml 2>/dev/null | wc -l)"
          echo "  ‚Ä¢ Widgets  : $(ls qml/components/*.qml 2>/dev/null | wc -l)"
          echo "  ‚Ä¢ Scripts  : $(ls server/*.js 2>/dev/null | grep -v node_modules | wc -l)"
